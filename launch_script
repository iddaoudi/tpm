#!/bin/bash

# Set OpenBLAS threads to 1
export OPENBLAS_NUM_THREADS=1

######################################################
################## Can be modified ###################
######################################################

# Parameters
algo=cholesky
msize=1024
bsize=512
threads=6
numa=12
ROOT=/home/idriss/Work/Software

######################################################
########## No modifications after this line ##########
######################################################

export TPM_TRACE=0
export TPM_TRACE_NO_OMPT=0
export TPM_POWER=0

export TPM_MACHINE=local
export OMP_PLACES=cores
export OMP_PROC_BIND=close

######################################################

# LD_PRELOAD
omp_so=${ROOT}/llvm-project/build-openmp/lib/libomp.so
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$ROOT/llvm-project/build-openmp/lib:$ROOT/OpenBLAS/build/lib

######################################################

if [[ "$algo" -eq "qr" ]];
then
    ulimit -s unlimited
fi

# Compile source part
cd algorithms
make clean && make -s
cd -

######################################################

for algorithm in ${algo[*]}
do
	for thread in ${threads[*]}
	do
		for matrix in ${msize[*]}
		do
			for tile in ${bsize[*]}
			do
			   export OMP_NUM_THREADS=$thread

			   # Launch runs
			   if [[ $thread -gt $numa ]]
			   then
			   		LD_PRELOAD=$omp_so numactl --physcpubind=0-$(expr $thread - 1) --membind=0,1 algorithms/tpm_benchmark -a $algorithm -m $matrix -b $tile
			   else
			   		LD_PRELOAD=$omp_so numactl --physcpubind=0-$(expr $thread - 1) --membind=0 algorithms/tpm_benchmark -a $algorithm -m $matrix -b $tile
			   fi
			done
		done
	done
done
